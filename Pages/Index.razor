@page "/"
@using MudBlazor
@using RadioHeardleServer.Data;
@using System.Globalization;
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage ProtectedSessionStore

@inject IJSRuntime JsRuntime;
@inject FileOperationsService fileOperationsService;


<PageTitle>Radioheardle</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small">
<MudStack>
	<MudCard>
		<MudCardContent>
			<MudText><h1>Radioheardle</h1></MudText>
			<MudText>@_editionDate</MudText>
			<MudText hidden="@gameIncomplete" Align="Align.Center" Typo="Typo.h4">@_songName</MudText>
			<MudStack Justify="Justify.Center">
				<MudChip hidden="@gameIncomplete" Color="@chipColor" Text="@chipText"></MudChip>
			</MudStack>
			<MudProgressLinear Color="Color.Secondary" Value="@BufferValue" Class="my-7" Size="Size.Medium"/>
			<MudProgressLinear Color="Color.Primary" Value="@Value" Class="my-7" Size="Size.Large" />
			<MudSwitch @bind-Checked="@PlaySwitch" Label="Play" Color="Color.Success" />
		</MudCardContent>
	</MudCard>

	<MudCard hidden="@GameCompleted">
		<MudCardContent>
				<MudStack Row=true Justify="Justify.Center">
				<MudButton @onclick="@HandleOnSkip" Disabled="@GameCompleted">@Skip</MudButton>
			</MudStack>
			<MudStack Row=true Spacing="4">
					<MudAutocomplete T="string" @bind-Value="@GuessText" Disabled="@GameCompleted" SearchFunc="@AutoComplete" MaxItems=5>
					<MoreItemsTemplate>
						<MudText Align="Align.Center" Class="px-4 py-1">
							...
						</MudText>
					</MoreItemsTemplate>
				</MudAutocomplete>
				<MudButton @onclick="@HandleOnGuess" Disabled="@GameCompleted">Guess</MudButton>
			</MudStack>
		</MudCardContent>
	</MudCard>
	<MudCard hidden="@gameIncomplete">
		<MudCardContent>
			<MudTextField @bind-Value="ResultText" Lines="3" Variant="Variant.Outlined" Label="Copy this text to show your mates" ReadOnly="true"></MudTextField>
		</MudCardContent>
	</MudCard>
</MudStack>
<MudCard hidden="@GameCompleted">
	<MudCardContent>
		<MudText Typo="Typo.body2">Guessing or Skipping will unlock the next section of the preview.</MudText>
				<MudText Typo="Typo.body2">(First 7 Albums)</MudText>
	</MudCardContent>
</MudCard>
</MudContainer>

<audio id="audioPlayer" src='@_audioAddress' type="audio/mpeg" />


@code {

	private static int _numGuesses = 5;
	private static int _totalSectionDuration = 20;
	private static int[] _sectionDurations = new int[] { 1, 2, 3, 5, 9, 0 };
	private static float _bufferPart = 100 / _totalSectionDuration;
	private static int _bufferTick = _totalSectionDuration * 10;

	public bool GameCompleted { get; set; } = false;
	public int Value { get; set; } = 0;
	public float BufferValue { get; set; } = _bufferPart * _sectionDurations[0];

	public string GuessText { get; set; }
	public string ResultText { get; set; }

	public string Skip { get; set; } = "Skip";

	private bool gameIncomplete = true;
	private Color chipColor;
	private string chipText;

	private bool _playSwitch = false;
	public bool PlaySwitch
	{
		get { return _playSwitch; }
		set { _playSwitch = value; HandleOnPlayChanged(); }
	}

	private string[] _skipIcons = new string[_numGuesses];

	private string _guesses = "";

	private string _audioAddress;
	private string _songName;
	private string _editionDate;
	private int _editionVersion;

	private int _localVersion;
	private string _localGuesses;
	private bool _localGameComplete;

	private bool _disposed;

	public void Dispose() => _disposed = true;

	private IJSObjectReference _jsModule;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			_jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/SoundScripts.js");
			await LoadLocalStorage();
			HandleStorageState();
		} 
	}

	protected override void OnInitialized()
	{
		var songData = fileOperationsService.GetData();

		_audioAddress = "./Audio/" + songData._songData._fileName;
		_songName = songData._songData._songName;
		_editionDate = songData._updateDate.DayOfWeek + " " + songData._updateDate.Date.ToString("d", new CultureInfo("en-uk"));
		_editionVersion = songData._version;
	}


	private async void HandleStorageState()
	{
		if (_localVersion == _editionVersion)
		{
			_guesses = _localGuesses;

			for (int i = 0; i <= _guesses.Length; i++)
			{
				BufferValue += _bufferPart * _sectionDurations[i];
			}

			HandleSkipPosition();

			if (_localGameComplete)
				CompleteGame();
		}
		else
		{
			Console.WriteLine("cookies don't match server version");
			await UpdateLocalStorage();
		}
	}

	private async Task LoadLocalStorage()
	{
		var version = await ProtectedSessionStore.GetAsync<int>("version");
		_localVersion = version.Success ? version.Value : 1;

		var guesses = await ProtectedSessionStore.GetAsync<string>("guesses");
		_localGuesses = guesses.Success && guesses.Value!=null ? guesses.Value : "";

		var complete = await ProtectedSessionStore.GetAsync<bool>("gameComplete");
		_localGameComplete = complete.Success ? complete.Value : false;
	}

	private async Task UpdateLocalStorage()
	{
		await ProtectedSessionStore.SetAsync("version", _editionVersion);
		await ProtectedSessionStore.SetAsync("guesses", _guesses);
		await ProtectedSessionStore.SetAsync("gameComplete", GameCompleted);
	}

	private async Task<IEnumerable<string>> AutoComplete(string search)
	{
		return fileOperationsService.GetSearchSongs(search);
	}

	private async void HandleOnPlayChanged()
	{
		if (_playSwitch)
		{
			CallJsFunc("PlaySound");

			//set timer
			var timer = new PeriodicTimer(TimeSpan.FromMilliseconds(_bufferTick));
			while (await timer.WaitForNextTickAsync() && Value <= BufferValue)
			{
				Value += 1;
				StateHasChanged();
			}

			PlaySwitch = false;
		}
		else
		{
			CallJsFunc("StopSound");
			Value = 0;
			StateHasChanged();
		}
	}

	private void HandleOnSkip()
	{
		GuessText = string.Empty;
		_guesses += 's';
		BufferValue += _bufferPart * _sectionDurations[_guesses.Length];
		HandleSkipPosition();
	}

	private void HandleOnGuess()
	{
		var song = _songName.Trim();

		if (GuessText == null || GuessText.Length == 0)
			return;

		if (string.Compare(GuessText.Trim(), song, StringComparison.InvariantCultureIgnoreCase) == 0)
		{
			_guesses += 'w';
			CompleteGame();
			UpdateLocalStorage();
		}
		else
		{
			_guesses += 'g';
			BufferValue += _bufferPart * _sectionDurations[_guesses.Length];
			HandleSkipPosition();
		}
	}

	private async void HandleSkipPosition()
	{
		if (_guesses.Length >= (_numGuesses))
		{
			if (!GameCompleted)
			{
				CompleteGame();
				await UpdateLocalStorage();
			}
		}
		else if (_guesses.Length == _numGuesses - 1)
		{
			Skip = "Give up";
		}

		await UpdateLocalStorage();

		StateHasChanged();
	}

	private void CompleteGame()
	{
		var win = _guesses.EndsWith('w');

		GuessText = _songName;
		GameCompleted = true;

		ResultText = ResultGenerator.GetResultText(_numGuesses, _guesses, _editionDate);

		chipColor = win ? Color.Success : Color.Error;
		chipText = win ? "Success" : "Failure";
		gameIncomplete = false;
		BufferValue = 100;
	}

	private void CallJsFunc(string funcName)
	{
		_jsModule.InvokeVoidAsync(funcName);
	}
}